# 卷积神经网络 Convolutional neural networks



### 从全连接层到卷积



#### 不变性

**平移不变性(translation invariance)**: 不管检测对象出现在图像中的哪个位置，神经网络的前面几层 应该对相同的图像区域具有相似的反应；

**局部性(locality)**: 神经网络的前面几层应该只探索输入图像中的局部区域，而不过度在意图像中相隔较远区域的关系，这就是“局部性”原则。最终，可以聚合这些局部特征，以在整个图像级别进行预测。





#### 卷积

数学中，两个函数 $g，f$之间的卷积定义为：
$$
(f*g)(\mathbf{x}) = \int f(\mathbf{z})g(\mathbf{x}-\mathbf{z})d\mathbf{z}
$$
也就是说，卷积是当把一个函数“翻转”并移位$x$时，测量f 和$g$之间的重叠.

离散对象中：
$$
(f*g)(i) = \sum_a f(a)g(i-a)
$$
对于二维张量：
$$
(f*g)(i,j) = \sum_a\sum_b f(a,b)g(i-a,j-b)
$$

#### 互相关运算 cross-correlation

卷积核的高度和宽度都是2

<img src="https://cdn.jsdelivr.net/gh/J-M-LIU/pic-bed@master//img/image-20220922233521867.png" alt="image-20220922233521867" style="zoom:50%;" />

卷积窗口从输入张量的左上⻆开始，从左到右、从上到下滑动。当卷积窗口滑动到新 一个位置时，包含在该窗口中的部分张量与卷积核张量进行按元素相乘。

输入长 X 宽：$n_h \times n_w$ ,卷积核长 X 宽：$k_h\times k_w$, 输出大小为：
$$
(n_h - k_h+1)\times (n_w - k_w + 1)
$$



### Padding

通常，如果我们添加$p_h$ 行填充(大约一半在顶部，一半在底部)和$p_w$ 列填充(左侧大约一半，右侧一半)，则输出形状将为
$$
(n_h −k_h +p_h +1)×(n_w −k_w +p_w +1)
$$
<img src="https://cdn.jsdelivr.net/gh/J-M-LIU/pic-bed@master//img/image-20220922235600677.png" alt="image-20220922235600677" style="zoom:50%;" />

即输出高度和宽度分别增加 $p_h$和 $p_w$。

在许多情况下，我们需要设置$p_h = k_h − 1$和$p_w = k_w − 1$，使输入和输出具有相同的高度和宽度。这样可以在 构建网络时更容易地预测每个图层的输出形状。假设$k_h$ 是奇数，我们将在高度的两侧填充$p_h /2$行。如果$k_h$ 是 偶数，则一种可能性是在输入顶部填充<br>⌈$p_h /2$⌉行，在底部填充⌊$p_h /2$⌋行。同理，我们填充宽度的两侧。





### Stride

通常，当垂直步幅为$s_h$ 、水平步幅为$s_w$ 时，输出形状为:
$$
⌊(n_h −k_h +p_h +s_h)/s_h⌋×⌊(n_w −k_w +p_w +s_w)/s_w⌋
$$
在实践中，我们很少使用不一致的步幅或填充

<img src="https://cdn.jsdelivr.net/gh/J-M-LIU/pic-bed@master//img/image-20220923095020904.png" alt="image-20220923095020904" style="zoom:50%;" />

**通用公式**
$$
feature\ map\ size:((n_h −k_h +2* p_h)/s_h + 1)×((n_w −k_w + 2 * p_w )/s_w + 1)
$$
padding = "same" ，仅当stride=1时，padding = $(k-1)/2$



### 汇聚层 Pooling

池化层不包含参数，其运算是确定性的，通常计算汇聚窗口中所有元素的最大值或平均值。分别称为**最大汇聚层(maximum pooling)**和**平均汇聚层(average pooling)**。

<img src="https://cdn.jsdelivr.net/gh/J-M-LIU/pic-bed@master//img/image-20220923101626049.png" alt="image-20220923101626049" style="zoom:50%;" />

